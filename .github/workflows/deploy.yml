name: Deploy n8n to Fly

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1
      - name: Login to Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl auth login --access-token $FLY_API_TOKEN
      - name: Optionally set Fly secrets (if provided in repo secrets)
        env:
          FLY_APP: ${{ secrets.FLY_APP_NAME }}
          POSTGRES_DATABASE_URL: ${{ secrets.POSTGRES_DATABASE_URL }}  # optional
          N8N_BASIC_AUTH_USER: ${{ secrets.N8N_BASIC_AUTH_USER }}      # optional
          N8N_BASIC_AUTH_PASSWORD: ${{ secrets.N8N_BASIC_AUTH_PASSWORD }}# optional
        run: |
          if [ -n "$POSTGRES_DATABASE_URL" ]; then
            flyctl secrets set POSTGRES_DATABASE_URL="$POSTGRES_DATABASE_URL" --app "$FLY_APP"
          fi
          if [ -n "$N8N_BASIC_AUTH_USER" ] && [ -n "$N8N_BASIC_AUTH_PASSWORD" ]; then
            flyctl secrets set N8N_BASIC_AUTH_USER="$N8N_BASIC_AUTH_USER" N8N_BASIC_AUTH_PASSWORD="$N8N_BASIC_AUTH_PASSWORD" --app "$FLY_APP"
          fi

      - name: Create Fly resources (optional)
        if: ${{ secrets.CREATE_FLY_RESOURCES == 'true' }}
        env:
          FLY_APP: ${{ secrets.FLY_APP_NAME }}
          REGION: ${{ secrets.FLY_REGION }}
        run: |
          REGION=${REGION:-ord}
          echo "Creating Fly volume 'n8n-data' (idempotent)"
          flyctl volumes create n8n-data --region $REGION --size 3 || echo "volume exists or creation failed"
          echo "Attempting to create managed Postgres (non-fatal)"
          flyctl postgres create --name "${FLY_APP}-db" --region $REGION || echo "postgres create failed or already exists; check Fly dashboard"

      - name: Deploy to Fly
        env:
          FLY_APP: ${{ secrets.FLY_APP_NAME }}
        run: flyctl deploy --app "$FLY_APP" --config fly.toml --remote-only
